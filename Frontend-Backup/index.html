<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TheLionKing Demo</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 1rem; }
    .row { display: flex; gap: 1rem; flex-wrap: wrap; }
    .col { flex: 1 1 320px; }
    fieldset { margin-bottom: 1rem; }
    .pdf-frame { width: 100%; height: 480px; border: 1px solid #ccc; }
    pre { background: #f6f8fa; padding: .75rem; overflow: auto; max-height: 480px; }
    .muted { color: #666; font-size: .9rem; }
    button { padding: .5rem .75rem; }
    input[type="text"] { width: 100%; padding: .4rem; }
  </style>
  <script>
    async function startPreview() {
      const baseUrlInput = document.getElementById('baseUrl');
      const fileInput = document.getElementById('pdfFile');
      const statusEl = document.getElementById('status');
      const idEl = document.getElementById('processId');
      const jsonEl = document.getElementById('json');
      const pdfsEl = document.getElementById('pdfs');
      const previewEl = document.getElementById('doclingPreview');
      const continueWrapEl = document.getElementById('continueWrap');

      jsonEl.textContent = '';
      pdfsEl.innerHTML = '';
      previewEl.textContent = '';
      continueWrapEl.style.display = 'none';

      const baseUrl = (baseUrlInput.value || '').replace(/\/$/, '');
      if (!fileInput.files || fileInput.files.length === 0) {
        alert('Bitte ein PDF auswählen.');
        return;
      }
      const file = fileInput.files[0];
      statusEl.textContent = 'Sende /start-preview...';
      idEl.textContent = '-';

      try {
        const startResp = await fetch(baseUrl + '/v1/start-preview', {
          method: 'POST',
          headers: { 'Content-Type': 'application/pdf' },
          body: file
        });

        if (startResp.status !== 202) {
          const text = await startResp.text();
          statusEl.textContent = 'Fehler bei /start-preview: ' + startResp.status + ' ' + startResp.statusText;
          jsonEl.textContent = text;
          return;
        }
        const startJson = await startResp.json();
        const id = startJson.id || startJson;
        idEl.textContent = id;
        statusEl.textContent = 'Docling-Preview gestartet. Warte auf Vorschau...';
        pollPreview(baseUrl, id);
      } catch (e) {
        statusEl.textContent = 'Fehler: ' + (e && e.message ? e.message : e);
      }
    }

    async function pollPreview(baseUrl, id) {
      const statusEl = document.getElementById('status');
      const jsonEl = document.getElementById('json');
      const previewEl = document.getElementById('doclingPreview');
      const continueWrapEl = document.getElementById('continueWrap');

      async function once() {
        try {
          const resp = await fetch(baseUrl + '/v1/preview/' + encodeURIComponent(id), {
            headers: { 'Accept': 'application/json' }
          });
          if (resp.status === 202) {
            let progressText = '';
            try {
              const p = await resp.json();
              if (p && typeof p.progress === 'number') progressText = ' (' + p.progress + '%)';
            } catch {}
            statusEl.textContent = 'Docling läuft' + progressText + '...';
            setTimeout(once, 2000);
            return;
          }
          if (!resp.ok) {
            const text = await resp.text();
            statusEl.textContent = 'Fehler bei /preview: ' + resp.status + ' ' + resp.statusText;
            jsonEl.textContent = text;
            return;
          }
          const preview = await resp.json();
          renderPreview(preview);
          continueWrapEl.style.display = 'block';
          statusEl.textContent = 'Docling-Vorschau fertig. Jetzt LLM-Verarbeitung starten.';
        } catch (e) {
          statusEl.textContent = 'Fehler: ' + (e && e.message ? e.message : e);
        }
      }
      once();
    }

    function renderPreview(preview) {
      const previewEl = document.getElementById('doclingPreview');
      const pages = (preview && Array.isArray(preview.pages)) ? preview.pages : [];
      const clean = pages.map(p => ({
        pageIndex: p.pageIndex,
        usable: p.usable,
        markdown: p.markdown,
        json: p.json
      }));
      previewEl.textContent = JSON.stringify(clean, null, 2);
    }

    async function startLlmProcessing() {
      const baseUrl = (document.getElementById('baseUrl').value || '').replace(/\/$/, '');
      const id = (document.getElementById('processId').textContent || '').trim();
      const statusEl = document.getElementById('status');
      const jsonEl = document.getElementById('json');
      if (!id || id === '-') {
        alert('Keine Prozess-ID vorhanden.');
        return;
      }
      const proceed = window.confirm('Docling-Vorschau wurde angezeigt. Soll jetzt die LLM-Verarbeitung gestartet werden?');
      if (!proceed) return;

      statusEl.textContent = 'Starte LLM-Verarbeitung...';
      try {
        const resp = await fetch(baseUrl + '/v1/continue/' + encodeURIComponent(id), { method: 'POST' });
        if (!resp.ok && resp.status !== 202) {
          const text = await resp.text();
          statusEl.textContent = 'Fehler bei /continue: ' + resp.status + ' ' + resp.statusText;
          jsonEl.textContent = text;
          return;
        }
        statusEl.textContent = 'LLM-Verarbeitung gestartet. Warte auf Ergebnis...';
        pollResult(baseUrl, id);
      } catch (e) {
        statusEl.textContent = 'Fehler: ' + (e && e.message ? e.message : e);
      }
    }

    async function pollResult(baseUrl, id) {
      const statusEl = document.getElementById('status');
      const jsonEl = document.getElementById('json');
      const pdfsEl = document.getElementById('pdfs');
      let retryMs = 3000;

      async function once() {
        try {
          const resp = await fetch(baseUrl + '/v1/result/' + encodeURIComponent(id), {
            headers: { 'Accept': 'application/json' }
          });
          if (resp.status === 202) {
            // Progress only; body may be empty depending on backend wiring
            let progressText = '';
            try {
              const p = await resp.json();
              if (p && typeof p.progress === 'number') progressText = ' (' + p.progress + '%)';
            } catch {}
            statusEl.textContent = 'Noch in Arbeit' + progressText + '...';
            const ra = resp.headers.get('Retry-After');
            const n = parseInt(ra, 10);
            setTimeout(once, isFinite(n) ? n * 1000 : retryMs);
            return;
          }
          if (resp.ok) {
            const result = await resp.json();
            statusEl.textContent = 'Fertig.';
            renderResult(result);
            return;
          }
          // Error with body
          const text = await resp.text();
          statusEl.textContent = 'Fehler bei /result: ' + resp.status + ' ' + resp.statusText;
          jsonEl.textContent = text;
        } catch (e) {
          statusEl.textContent = 'Fehler: ' + (e && e.message ? e.message : e);
        }
      }
      once();
    }

    function renderResult(result) {
      const jsonEl = document.getElementById('json');
      const pdfsEl = document.getElementById('pdfs');
      // Clone and strip binary to keep JSON readable
      const clean = JSON.parse(JSON.stringify(result || {}));
      if (Array.isArray(clean.documents)) {
        clean.documents.forEach(d => { if (d && d.documentData) d.documentData = '<omitted base64 pdf>'; });
      }
      jsonEl.textContent = JSON.stringify(clean, null, 2);

      // Visualize each document and show its JSON (without binary)
      const docs = (result && Array.isArray(result.documents)) ? result.documents : [];
      pdfsEl.innerHTML = '';
      docs.forEach((d, idx) => {
        const box = document.createElement('div');
        box.className = 'col';
        const title = document.createElement('div');
        title.className = 'muted';
        title.textContent = 'Dokument #' + (idx + 1) + (d && d.category ? ' (' + d.category + ')' : '');
        box.appendChild(title);
        if (d && d.documentData) {
          const url = 'data:application/pdf;base64,' + d.documentData;
          const iframe = document.createElement('iframe');
          iframe.className = 'pdf-frame';
          iframe.src = url;
          box.appendChild(iframe);
        }
        // Show per-document JSON mapping (no binary)
        const docClean = JSON.parse(JSON.stringify(d || {}));
        if (docClean.documentData) docClean.documentData = '<omitted base64 pdf>';
        const pre = document.createElement('pre');
        pre.textContent = JSON.stringify(docClean, null, 2);
        box.appendChild(pre);
        pdfsEl.appendChild(box);
      });
    }

    async function fetchExisting() {
      const baseUrl = (document.getElementById('baseUrl').value || '').replace(/\/$/, '');
      const idInput = document.getElementById('existingId');
      const id = (idInput.value || '').trim();
      const statusEl = document.getElementById('status');
      const idEl = document.getElementById('processId');
      if (!id) { alert('Bitte eine Prozess-ID eingeben.'); return; }
      idEl.textContent = id;
      statusEl.textContent = 'Hole Ergebnis...';
      pollResult(baseUrl, id);
    }

    function setDefaultBaseUrl() {
      // Default to local backend
      document.getElementById('baseUrl').value = 'http://localhost:8181';
    }
    window.addEventListener('DOMContentLoaded', setDefaultBaseUrl);
  </script>
</head>
<body>
  <h1>TheLionKing Frontend Demo</h1>
  <fieldset>
    <legend>Einstellungen</legend>
    <label>Backend Base URL
      <input id="baseUrl" type="text" placeholder="http://localhost:8181" />
    </label>
  </fieldset>
  <fieldset>
    <legend>PDF hochladen und Docling-Vorschau starten</legend>
    <input id="pdfFile" type="file" accept="application/pdf" />
    <button onclick="startPreview()">Docling-Vorschau starten</button>
    <div id="continueWrap" style="display:none; margin-top:.5rem;">
      <button onclick="startLlmProcessing()">LLM-Verarbeitung jetzt starten</button>
    </div>
    <div id="status" class="muted">Bereit.</div>
    <div class="muted">Process ID: <span id="processId">-</span></div>
  </fieldset>

  <fieldset>
    <legend>Vorhandene Prozess-ID abrufen</legend>
    <input id="existingId" type="text" placeholder="Prozess-ID" />
    <button onclick="fetchExisting()">Ergebnis abrufen</button>
  </fieldset>

  <div class="row">
    <div class="col">
      <h3>Docling Vorschau</h3>
      <pre id="doclingPreview"></pre>
    </div>
    <div class="col">
      <h3>Result JSON</h3>
      <pre id="json"></pre>
    </div>
    <div class="col" style="flex:2 1 480px">
      <h3>Erkannte PDFs</h3>
      <div id="pdfs" class="row"></div>
    </div>
  </div>
</body>
</html>
